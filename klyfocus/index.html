<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eBook Reader PWA</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body, html {
      height: 100%;
      overflow: hidden;
      background-color: #000;
      color: #ccc;
    }
    header, footer {
      padding: 10px;
      background-color: #222;
    }
    #reader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: calc(100% - 120px);
    }
    canvas, pre {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
    }
    #fullscreenContainer {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <header class="d-flex flex-wrap align-items-center justify-content-between">
    <a href="https://discord.gg/nT6MnfP63G" target="_blank" class="text-decoration-none text-primary d-flex align-items-center">
      <i class="bi bi-discord fs-3 me-2"></i>
      <span>CONSIGUE LIBROS GRATIS EN NUESTRO DISCORD</span>
    </a>
    <h1 class="w-100 text-center fs-3 my-2">Lector de ebooks</h1>
    <div class="d-flex flex-wrap align-items-center justify-content-center w-100">
      <label for="fileInput" class="btn btn-secondary m-1">
        <i class="bi bi-upload"></i> Seleccionar Archivo
      </label>
      <input type="file" id="fileInput" accept=".txt,.pdf">
      <button id="fullscreenBtn" class="btn btn-secondary m-1">
        <i class="bi bi-arrows-fullscreen"></i> Leer libro.
      </button>
      <button id="toggleTheme" class="btn btn-secondary m-1">
        <i class="bi bi-moon"></i> Modo Claro/Oscuro
      </button>
      <label for="fontSize" class="form-label m-1">Tamaño letra</label>
      <input type="range" id="fontSize" min="12" max="32" value="16" class="form-range w-auto m-1">
    </div>
  </header>

  <div id="reader"></div>

  <footer class="d-flex flex-wrap align-items-center justify-content-center">
    <button id="prevPage" class="btn btn-secondary m-1">
      <i class="bi bi-arrow-left"></i> Anterior
    </button>
    <button id="nextPage" class="btn btn-secondary m-1">
      Siguiente <i class="bi bi-arrow-right"></i>
    </button>
    <button id="bookmark" class="btn btn-secondary m-1">
      <i class="bi bi-bookmark"></i> Guardar Marcador
    </button>
    <button id="goBookmark" class="btn btn-secondary m-1">
      <i class="bi bi-journal-arrow-up"></i> Ir a Marcador
    </button>
    <input type="text" id="searchText" placeholder="Buscar texto" class="form-control m-1 w-auto">
    <button id="searchBtn" class="btn btn-secondary m-1">
      <i class="bi bi-search"></i> Buscar
    </button>
  </footer>

  <div id="fullscreenContainer" style="display:none;"></div>

  <script>
    let ebookContent = '';
    let currentPage = 0;
    let pageSize = 1000;
    let pdfDoc = null;
    const readerDiv = document.getElementById('reader');
    const fullscreenContainer = document.getElementById('fullscreenContainer');

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            pdfDoc = pdf;
            currentPage = 1;
            renderPDFPage();
          });
        };
        fileReader.readAsArrayBuffer(file);
      } else {
        const readerFile = new FileReader();
        readerFile.onload = function(event) {
          ebookContent = event.target.result;
          currentPage = 0;
          renderTextPage();
        };
        readerFile.readAsText(file);
      }
    });

    function renderTextPage() {
      fullscreenContainer.innerHTML = '<pre>' + ebookContent.slice(currentPage * pageSize, (currentPage + 1) * pageSize) + '</pre>';
      readerDiv.innerHTML = '<pre>' + ebookContent.slice(currentPage * pageSize, (currentPage + 1) * pageSize) + '</pre>';
      localStorage.setItem('lastPage', currentPage);
    }

    function renderPDFPage() {
      pdfDoc.getPage(currentPage).then(function(page) {
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        fullscreenContainer.innerHTML = '';
        fullscreenContainer.appendChild(canvas);
        readerDiv.innerHTML = '';
        readerDiv.appendChild(canvas.cloneNode());
        page.render({ canvasContext: fullscreenContainer.firstChild.getContext('2d'), viewport: viewport });
        page.render({ canvasContext: readerDiv.firstChild.getContext('2d'), viewport: viewport });
      });
    }

    document.getElementById('prevPage').addEventListener('click', prevPage);
    document.getElementById('nextPage').addEventListener('click', nextPage);

    function prevPage() {
      if (pdfDoc) {
        if (currentPage > 1) currentPage--;
        renderPDFPage();
      } else {
        if (currentPage > 0) currentPage--;
        renderTextPage();
      }
    }

    function nextPage() {
      if (pdfDoc) {
        if (currentPage < pdfDoc.numPages) currentPage++;
        renderPDFPage();
      } else {
        if ((currentPage + 1) * pageSize < ebookContent.length) currentPage++;
        renderTextPage();
      }
    }

    document.getElementById('bookmark').addEventListener('click', () => {
      localStorage.setItem('bookmark', currentPage);
      alert('Marcador guardado en página ' + currentPage);
    });

    document.getElementById('goBookmark').addEventListener('click', () => {
      const bookmark = localStorage.getItem('bookmark');
      if (bookmark !== null) {
        currentPage = parseInt(bookmark);
        if (pdfDoc) renderPDFPage();
        else renderTextPage();
      }
    });

    document.getElementById('toggleTheme').addEventListener('click', () => {
      if (document.body.style.backgroundColor === 'white') {
        document.body.style.backgroundColor = '#000';
        document.body.style.color = '#ccc';
      } else {
        document.body.style.backgroundColor = 'white';
        document.body.style.color = 'black';
      }
    });

    document.getElementById('fontSize').addEventListener('input', (e) => {
      readerDiv.style.fontSize = e.target.value + 'px';
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const query = document.getElementById('searchText').value;
      if (!pdfDoc && ebookContent) {
        const index = ebookContent.indexOf(query);
        if (index !== -1) {
          currentPage = Math.floor(index / pageSize);
          renderTextPage();
        } else {
          alert('Texto no encontrado');
        }
      } else {
        alert('La búsqueda en PDF no está implementada.');
      }
    });

    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      fullscreenContainer.style.display = 'flex';
      if (pdfDoc) renderPDFPage();
      else renderTextPage();
    });

    fullscreenContainer.addEventListener('click', () => {
      fullscreenContainer.style.display = 'none';
    });

    let startX = 0;
    fullscreenContainer.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    });

    fullscreenContainer.addEventListener('touchend', (e) => {
      const endX = e.changedTouches[0].clientX;
      if (startX - endX > 50) {
        nextPage();
      } else if (endX - startX > 50) {
        prevPage();
      }
    });

    if (localStorage.getItem('lastPage')) {
      currentPage = parseInt(localStorage.getItem('lastPage'));
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>